<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/users_sql.controller.js.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/users_sql.controller.js.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const usersModel = require('../models/users_sql.model');
const jwt = require('jsonwebtoken')
const bcrypt = require('bcrypt');
const isAdmin = require("./isAdmin"); 

/** 
* @author Antonio Mangado &amp; Cristina Mateo
* @method getUser 
* @async
* @param req - email,password
* @param res - the response renders a different pug file depending if the logged email has a user or admin role. Email is checked by using cookies.
* @exports getUser
*/
// Read User
const getUser = async (req, res) => {
    const { email, password } = req.body
    console.log(req.body)
    if (!email || !password) {
        res.status(400).send("Please provide an email or password to log in!")
    } else {
        let user = await usersModel.getUsersByEmail(email);//esto accede a user.models y llama a esa funcion allí
        
        const hashPassword = user[0].password
        if(user.length = 0){
            res.status(400).json({ msg: 'Incorrect user or password'}); 
        }else{
            const match = await bcrypt.compare(password, hashPassword);
            if(match){
                const data = await usersModel.loginUser(email)
                const userForToken = {
                    email: data.email,
                    username: data.username,
                };
                const token = jwt.sign(userForToken, process.env.CLIENT_SECRET, {expiresIn: '60m'});

                //Almacenamos el token en las cookies
                res.cookie("access-token", token, {
                    httpOnly: true,
                    sameSite: "strict",
                })
                res.cookie("logged-email", req.body.email,{
                    httpOnly: true,
                    sameSite: "strict",
                })
            
                if(isAdmin(req.body.email)){
                    res.redirect("/admin/search")
                } else{
                    res.render("dashboard");
                }
            } else {
                res.status(400).json({ msg: 'Incorrect user or password'});
            }
        }       
        // res.status(200).json(user); // [] con los users encontradas
    }
    
}

/** 
* @author Antonio Mangado &amp; Cristina Meteo
* @method createUser
* @async
* @param req - username,email,image
* @param res - the response, in this case returns status(201) and redirects user to login site or (400) if sign up goes wrong.
* @exports createUser
*/
// Create User
const createUser = async (req, res) => {
    const newUser = req.body;
    if (newUser.password == newUser.password2) {
        const response = await usersModel.createUser(newUser); 
        const token = jwt.sign({email: newUser.email}, process.env.CLIENT_SECRET, {
            expiresIn: '60m'
        })
        res.status(201).redirect("/");
    } else {
        res.status(400).json({
            msg: "The passwords do not match"
        }) 
    }
}

/** 
* @author Cristina Mateo
* @method deleteUser  
* @async
* @param req - email
* @param res - the response, in this case returns status(201) and deletes the current user.
* @exports deleteUser
*/
//DELETE
const deleteUser = async (req, res) => {
    const deleteUser = req.body;
    const response = await usersModel.deleteUser(deleteUser);
    res.status(201).json({
        "items_deleted": response,
        data: deleteUser
    });
}

module.exports = {
    getUser,
    createUser,
    deleteUser
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="addFavMovies%2520-%2520requests%2520information%2520from%2520the%2520body.module_%2520Then%2520adds%2520the%2520favourite%2520movie%2520into%2520the%2520response..html"> Then adds the favourite movie into the response.</a></li><li><a href="getFavMovies%2520-%2520requests%2520user%2520email.module_%2520Then%2520gets%2520the%2520favourite%2520movies%2520of%2520this%2520user..html"> Then gets the favourite movies of this user.</a></li><li><a href="module-Success.html">Success</a></li><li><a href="module-addFavMovies%2520-%2520adds%2520to%2520favourite%2520movie%2520in%2520the%2520database.html">addFavMovies - adds to favourite movie in the database</a></li><li><a href="module-createMovie%2520-%2520creates%2520a%2520movie%2520that%2520is%2520not%2520in%2520the%2520database%2520or%2520API.html">createMovie - creates a movie that is not in the database or API</a></li><li><a href="module-createMovie%2520-%2520creates%2520the%2520movie%2520and%2520sends%2520it%2520to%2520a%2520rendered%2520pug%2520file..html">createMovie - creates the movie and sends it to a rendered pug file.</a></li><li><a href="module-createUser.html">createUser</a></li><li><a href="module-createUser%2520-%2520creates%2520a%2520user%2520in%2520the%2520database.html">createUser - creates a user in the database</a></li><li><a href="module-deleteFavMovies%2520-%2520requests%2520information%2520from%2520the%2520body..html">deleteFavMovies - requests information from the body.</a></li><li><a href="module-deleteFromFav%2520-%2520deletes%2520from%2520favourite%2520films.html">deleteFromFav - deletes from favourite films</a></li><li><a href="module-deleteMovie%2520-%2520updates%2520a%2520movie%2520in%2520database..html">deleteMovie - updates a movie in database.</a></li><li><a href="module-deleteUser.html">deleteUser</a></li><li><a href="module-deleteUser%2520-%2520delete%2520a%2520user%2520from%2520the%2520database.html">deleteUser - delete a user from the database</a></li><li><a href="module-extractOpinionData%2520-%2520gets%2520opionions%2520from%2520other%2520websites.html">extractOpinionData - gets opionions from other websites</a></li><li><a href="module-failure.html">failure</a></li><li><a href="module-getFavMovies%2520-%2520gets%2520favourite%2520movies%2520from%2520database.html">getFavMovies - gets favourite movies from database</a></li><li><a href="module-getForm.html">getForm</a></li><li><a href="module-getLogin.html">getLogin</a></li><li><a href="module-getRecomendation%2520-%2520requests%2520information%2520from%2520the%2520mongo%2520db%2520or%2520the%2520API%2520and%2520sends%2520it%2520to%2520a%2520rendered%2520pug%2520file..html">getRecomendation - requests information from the mongo db or the API and sends it to a rendered pug file.</a></li><li><a href="module-getRecomendationInfoAPI%2520-%2520fetches%2520title%2520and%2520image%2520from%2520the%2520movie%2520API.html">getRecomendationInfoAPI - fetches title and image from the movie API</a></li><li><a href="module-getSearchBar.html">getSearchBar</a></li><li><a href="module-getUpdateForm.html">getUpdateForm</a></li><li><a href="module-getUser.html">getUser</a></li><li><a href="module-getUsersByEmail%2520-%2520gets%2520a%2520user%2520from%2520the%2520database..html">getUsersByEmail - gets a user from the database.</a></li><li><a href="module-isAdmin%2520-%2520check%2520if%2520role_admin.html">isAdmin - check if role:admin</a></li><li><a href="module-loginUser.html">loginUser</a></li><li><a href="module-logout.html">logout</a></li><li><a href="module-manage404.html">manage404</a></li><li><a href="module-protectView%2520-%2520requests%2520headers%2520authorization(token)..html">protectView - requests headers authorization(token).</a></li><li><a href="module-scrap%2520-%2520does%2520scraping.html">scrap - does scraping</a></li><li><a href="module-showFilms.html">showFilms</a></li><li><a href="module-updateMovie%2520-%2520updates%2520a%2520movie%2520in%2520database..html">updateMovie - updates a movie in database.</a></li><li><a href="module-validateEmail%2520-%2520validates%2520email.html">validateEmail - validates email</a></li><li><a href="module-validatePassword%2520-%2520validates%2520password.html">validatePassword - validates password</a></li><li><a href="showDetailedView%2520-%2520requests%2520by%2520id%2520in%2520the%2520database,%2520if%2520no%2520results,module_%2520in%2520the%2520API..html"> in the API.</a></li></ul><h3>Global</h3><ul><li><a href="global.html#getCrewInfoByID-fetchesstaffinformationfromthemovieAPIbyID.">getCrewInfoByID - fetches staff information from the movie API by ID.</a></li><li><a href="global.html#getMovieDetails-fetchesdatafromthemovieAPIbymovietitle.">getMovieDetails - fetches data from the movie API by movie title.</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Tue Nov 28 2023 17:32:15 GMT+0100 (hora estándar de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
