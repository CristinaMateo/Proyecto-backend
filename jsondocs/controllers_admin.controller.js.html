<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/admin.controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/admin.controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
const Movie = require('../models/admin.model');
const fetch = require("../utils/fetch.js");

/** 
* @author Cristina Mateo
* @method getForm 
* @param res - the response, in this case, renders a pug file.
* @exports getForm
*/

//mostrar form para crear peli
const getForm = (req, res) => {
    res.render('createMovie.pug');
}

/** 
* @author Cristina Mateo
* @method getUpdateForm 
* @param res - the response, in this case, renders a pug file.
* @exports getUpdateForm
*/
//mostrar form para update peli
const getUpdateForm = (req, res) => {
    res.render("updateForm.pug")
}


/** 
* @author Cristina Mateo
* @method createMovie - creates the movie and sends it to a rendered pug file. 
* @async
* @throws {error}
* @param req - title,release_date,director,genre,poster_path,runtime,overview,cast,vote_average
* @param res - the response, in this case, renders a pug file.
* @exports createMovie
*/

//Crear peli
async function createMovie(req, res){
try{
    const{title, release_date, director, genre, poster_path, runtime, overview, cast, vote_average} = req.body
  
   await Movie.create({ 
    title,
    release_date,
    director,
    genre,
    poster_path,
    runtime,
    overview,
    cast,
    vote_average });

    res.render('peticionOK.pug')

   }
   catch(error){
    res.render('peticionNO.pug')
   }
};

/** 
* @author Cristina Mateo
* @method getSearchBar
* @param res - the response, in this case, renders a pug file.
* @exports getSearchBar
*/

//get search bar
const getSearchBar =(req, res) => {
  res.render("adminSearch")
}

// Controlador para el formulario tipo POST
const searchFilmsByTitle = (req, res) => {
    const title = req.body.title;
    res.redirect(`/admin/search/${title}`); //Redirigimos a search/:title    
}

/** 
* @author Antonio Mangado
* @method showFilms
* @param res - the response, in this case, renders a pug file with a list of the searched movie and it's versions in the database.
* @exports showFilms
*/

  const showFilms = async (req, res) => {
    const title = req.params.title;
    try {
        let movieDetails =  await Movie.find({title}, "-__v") // => devuelve [{pelicula}, {pelicula}]
        if (movieDetails.length != 0) {
            res.render("admin-list-db", { movieDetails })
        } else {
            movieDetails = await fetch.getMovieDetails(title) // => devuelve [] con resultados
            const ids = movieDetails.map(movie => movie.id)
            const getStaff = async function () {
                let director = []
                for await (const id of ids) {
                    const staff = await fetch.getCrewInfobyID(id)
                    const crewInfo = staff.crew;
                    const directorObject = crewInfo.find(person => person.job == "Director")
                    if (directorObject) {
                        const directorName = directorObject.name || "Unknown";
                        director.push(directorName)
                    } else {
                        director.push("Unknown director")
                    }
                }
                return director
            };

            const getRunTimeAndGenre = async function () {
                let runTimes = [];
                let genre = [];
                for await (const id of ids) {
                    const movie = await fetch.getMovieByID(id)
                    if (movie.genres.length > 0) {
                        const genreName = movie.genres[0].name
                        genre.push(genreName)
                    } else {
                        genre.push("Unknown Genre")
                    }

                    const time = movie.runtime
                    if (time == 0) {
                        runTimes.push("No data")
                    } else {
                        runTimes.push(time) 
                    }
                }
                return { runTimes, genre }
            };
            const directors =  await getStaff()
            const genreAndRuntime = await getRunTimeAndGenre()
            for (let i = 0; i &lt; directors.length; i++) {
                movieDetails[i].director = directors[i]
                movieDetails[i].runtime = genreAndRuntime.runTimes[i]
                movieDetails[i].genre = genreAndRuntime.genre[i]
            }
            res.render("admin-film-list", { movieDetails })
                }
    }
    catch (error) {
        console.log(`ERROR: ${error.stack}`);
        res.status(400).json({msj:`ERROR: ${error.stack}`});
    }
}

/** 
* @author Antonio Mangado &amp; Cristina Mateo
* @method showDetailedView - requests by id in the database, if no results, in the API. 
* @async
* @param req - id
* @param res - the response, in this case, renders a pug file.
* @exports showDetailedView
*/

const showDetailedView = async (req, res) => {
    const id = req.params.id;
    // Primero hacemos busqueda en base de datos por ID
    if (id.length > 20) {
        let movieDetails =  await Movie.find({_id: id}, "-__v")
        movieDetails = movieDetails[0];
        
        res.render("adminDetails", { movieDetails })
    } else {
        // Luego buscamos en API si no se obtienen resultados
        movieDetails = await fetch.getMovieByID(id) // => devuelve un objeto
        const staff = await fetch.getCrewInfobyID(id)
        const crewInfo = staff.crew;
        const directorObject = crewInfo.find(person => person.job == "Director")
        const director = directorObject.name || "Unknown";
        movieDetails.director = director
        movieDetails.poster_path = `https://image.tmdb.org/t/p/w500${movieDetails.poster_path}`
        res.render("adminDetails", { movieDetails })
    }   
}

/** 
* @author Cristina Mateo
* @method updateMovie - updates a movie in database. 
* @async
* @param req -title
* @param res - the response renders a pug file to redirect to the search menu.
* @exports updateMovie
*/

const updateMovie = async (req, res) =>{
    try{
        let body = req.body;
        let {title} = req.params
        await Movie.updateOne({title}, body)
    res.render("peticionOK.pug")
}
    catch(error){
        res.render("peticionNO.pug")
    }
};

/** 
* @author Cristina Mateo
* @method deleteMovie - updates a movie in database. 
* @async
* @param req -title
* @param res - the response renders a pug file to redirect to the search menu.
* @exports deleteMovie
*/

const deleteMovie = async (req, res) => {
    try{
        let title = req.body.title;
        console.log("title:", title)
        await Movie.deleteOne({title});
    res.render("peticionOK.pug")
    }
    catch(error){
        res.render("peticionNO.pug")
    }
}


module.exports = {
    createMovie,
    getForm,
    getSearchBar,
    searchFilmsByTitle,
    showFilms,
    showDetailedView,
    updateMovie,
    getUpdateForm,
    deleteMovie
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="addFavMovies%2520-%2520requests%2520information%2520from%2520the%2520body.module_%2520Then%2520adds%2520the%2520favourite%2520movie%2520into%2520the%2520response..html"> Then adds the favourite movie into the response.</a></li><li><a href="getFavMovies%2520-%2520requests%2520user%2520email.module_%2520Then%2520gets%2520the%2520favourite%2520movies%2520of%2520this%2520user..html"> Then gets the favourite movies of this user.</a></li><li><a href="module-Success.html">Success</a></li><li><a href="module-addFavMovies%2520-%2520adds%2520to%2520favourite%2520movie%2520in%2520the%2520database.html">addFavMovies - adds to favourite movie in the database</a></li><li><a href="module-createMovie%2520-%2520creates%2520a%2520movie%2520that%2520is%2520not%2520in%2520the%2520database%2520or%2520API.html">createMovie - creates a movie that is not in the database or API</a></li><li><a href="module-createMovie%2520-%2520creates%2520the%2520movie%2520and%2520sends%2520it%2520to%2520a%2520rendered%2520pug%2520file..html">createMovie - creates the movie and sends it to a rendered pug file.</a></li><li><a href="module-createUser.html">createUser</a></li><li><a href="module-createUser%2520-%2520creates%2520a%2520user%2520in%2520the%2520database.html">createUser - creates a user in the database</a></li><li><a href="module-deleteFavMovies%2520-%2520requests%2520information%2520from%2520the%2520body..html">deleteFavMovies - requests information from the body.</a></li><li><a href="module-deleteFromFav%2520-%2520deletes%2520from%2520favourite%2520films.html">deleteFromFav - deletes from favourite films</a></li><li><a href="module-deleteMovie%2520-%2520updates%2520a%2520movie%2520in%2520database..html">deleteMovie - updates a movie in database.</a></li><li><a href="module-deleteUser.html">deleteUser</a></li><li><a href="module-deleteUser%2520-%2520delete%2520a%2520user%2520from%2520the%2520database.html">deleteUser - delete a user from the database</a></li><li><a href="module-extractOpinionData%2520-%2520gets%2520opionions%2520from%2520other%2520websites.html">extractOpinionData - gets opionions from other websites</a></li><li><a href="module-failure.html">failure</a></li><li><a href="module-getFavMovies%2520-%2520gets%2520favourite%2520movies%2520from%2520database.html">getFavMovies - gets favourite movies from database</a></li><li><a href="module-getForm.html">getForm</a></li><li><a href="module-getLogin.html">getLogin</a></li><li><a href="module-getRecomendation%2520-%2520requests%2520information%2520from%2520the%2520mongo%2520db%2520or%2520the%2520API%2520and%2520sends%2520it%2520to%2520a%2520rendered%2520pug%2520file..html">getRecomendation - requests information from the mongo db or the API and sends it to a rendered pug file.</a></li><li><a href="module-getRecomendationInfoAPI%2520-%2520fetches%2520title%2520and%2520image%2520from%2520the%2520movie%2520API.html">getRecomendationInfoAPI - fetches title and image from the movie API</a></li><li><a href="module-getSearchBar.html">getSearchBar</a></li><li><a href="module-getUpdateForm.html">getUpdateForm</a></li><li><a href="module-getUser.html">getUser</a></li><li><a href="module-getUsersByEmail%2520-%2520gets%2520a%2520user%2520from%2520the%2520database..html">getUsersByEmail - gets a user from the database.</a></li><li><a href="module-isAdmin%2520-%2520check%2520if%2520role_admin.html">isAdmin - check if role:admin</a></li><li><a href="module-loginUser.html">loginUser</a></li><li><a href="module-logout.html">logout</a></li><li><a href="module-manage404.html">manage404</a></li><li><a href="module-protectView%2520-%2520requests%2520headers%2520authorization(token)..html">protectView - requests headers authorization(token).</a></li><li><a href="module-scrap%2520-%2520does%2520scraping.html">scrap - does scraping</a></li><li><a href="module-showFilms.html">showFilms</a></li><li><a href="module-updateMovie%2520-%2520updates%2520a%2520movie%2520in%2520database..html">updateMovie - updates a movie in database.</a></li><li><a href="module-validateEmail%2520-%2520validates%2520email.html">validateEmail - validates email</a></li><li><a href="module-validatePassword%2520-%2520validates%2520password.html">validatePassword - validates password</a></li><li><a href="showDetailedView%2520-%2520requests%2520by%2520id%2520in%2520the%2520database,%2520if%2520no%2520results,module_%2520in%2520the%2520API..html"> in the API.</a></li></ul><h3>Global</h3><ul><li><a href="global.html#getCrewInfoByID-fetchesstaffinformationfromthemovieAPIbyID.">getCrewInfoByID - fetches staff information from the movie API by ID.</a></li><li><a href="global.html#getMovieDetails-fetchesdatafromthemovieAPIbymovietitle.">getMovieDetails - fetches data from the movie API by movie title.</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Tue Nov 28 2023 17:32:15 GMT+0100 (hora estándar de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
